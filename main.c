#include "gba.h"
#include "logic.h"
#include "draw.h"
// TA-TODO: Include any header files for title screen or exit
// screen images generated by nin10kit. Example for the provided garbage
// image:
#include "images/garbage.h"
#include "images/startScreen.h"
#include "images/coin.h"
#include "images/gamescreen.h"
#include "images/player.h"


#include <stdio.h>
#include <stdlib.h>

// AppState enum definition
typedef enum {
    // TA-TODO: Add any additional states you need for your app.
    START,
    START_NODRAW,
    APP_INIT,
    APP,
    APP_EXIT,
    APP_EXIT_NODRAW
} GBAState;

int main(void) {
    // TA-TODO: Manipulate REG_DISPCNT here to set Mode 3.
    REG_DISPCNT = MODE3 | BG2_ENABLE;

    GBAState state = START;

    // We store the "previous" and "current" states.
    AppState currentAppState, nextAppState;

    // We store the current and previous values of the button input.
    u32 previousButtons = BUTTONS;
    u32 currentButtons = BUTTONS;


    while (1) {
        // Load the current state of the buttons
        currentButtons = BUTTONS;

        // TA-TODO: Manipulate the state machine below as needed.
        switch(state) {
            case START:
                // Wait for VBlank
                waitForVBlank();

                // TA-TODO: Draw the start state here.
                //drawFullScreenImageDMA(garbage);
                drawFullScreenImageDMA(StartScreen);
                state = START_NODRAW;

                break;
            case START_NODRAW:


                // TA-TODO: Check for a button press here to start the app.
                // Start the app by switching the state to APP_INIT.
                if (KEY_DOWN(BUTTON_START, currentButtons) & ~KEY_JUST_PRESSED(BUTTON_START, currentButtons, previousButtons)) {
                    state = APP_INIT;
                }

                break;
            case APP_INIT:
                // Initialize the app. Switch to the APP state.
                initializeAppState(&currentAppState);
                initializeAppState(&nextAppState);

                // Draw the initial state of the app
                // fullDrawAppState(&currentAppState);
                drawFullScreenImageDMA(GameScreen);
                drawImageDMA(currentAppState.playerxLocation, currentAppState.playeryLocation, 20, 20, Player);
                drawString(120, 150, "Coins remaining: ", BLACK);
                drawString(currentAppState.stringxLocation, currentAppState.stringyLocation, "4", BLACK);
                drawRectDMA(136, 92, 15, 15, CUSTOM);


                state = APP;
                break;
            case APP:
                if (KEY_DOWN(BUTTON_SELECT, currentButtons)) {
                    state = START;
                }
                // Process the app for one frame, store the next state
                nextAppState = processAppState(&currentAppState, previousButtons, currentButtons);

                // Wait for VBlank before we do any drawing.
                waitForVBlank();

                int movedRight = currentAppState.playerxLocation < nextAppState.playerxLocation;
                int movedLeft = currentAppState.playerxLocation > nextAppState.playerxLocation;
                int movedDown = currentAppState.playeryLocation < nextAppState.playeryLocation;
                int movedUp = currentAppState.playeryLocation > nextAppState.playeryLocation;

                //Check where player moved and cover its trail
                if (movedDown) {
                    drawRectDMA(nextAppState.playerxLocation, nextAppState.playeryLocation - 1, 20, 1, CUSTOM);
                } 
                if (movedUp) {
                    drawRectDMA(nextAppState.playerxLocation, nextAppState.playeryLocation + 20, 20, 1, CUSTOM);
                }
                if (movedRight) {
                    drawRectDMA(nextAppState.playerxLocation - 1, nextAppState.playeryLocation, 1, 20, CUSTOM);
                }
                if (movedLeft) {
                    drawRectDMA(nextAppState.playerxLocation + 20, nextAppState.playeryLocation, 1, 20, CUSTOM);
                }

                if (vBlankCounter % 30 == 0) {
                    int *whichCoin = checkForCollisions(&nextAppState);

                    for(int i = 0; i < 5; i++) {
                        if (whichCoin[i]) {
                            coverCoin(&nextAppState, i);
                        }
                    }
                }

                
            
                //Draw player in new location
                drawImageDMA(nextAppState.playerxLocation, nextAppState.playeryLocation, 20, 20, Player);

                if (nextAppState.numOfCoinsCollected == 4) {
                    nextAppState.gameOver = 1;
                }

                // Check if the app is exiting. If it is, then go to the exit state.
                if (nextAppState.gameOver) {
                    currentAppState = nextAppState;
                    state = APP_EXIT;
                }

                // Now set the current state as the next state for the next iter.
                currentAppState = nextAppState;
                break;
            case APP_EXIT:
                // Wait for VBlank
                waitForVBlank();

                // TA-TODO: Draw the exit / gameover screen
                drawRectDMA(40, 40, 160, 80, MAGENTA);
                drawString(45, 45, "You won! Nicely done!", BLACK);
                drawString(45, 100, "Press START to", BLACK);
                drawString(45, 110, "return to start screen", BLACK);

                state = APP_EXIT_NODRAW;
                break;
            case APP_EXIT_NODRAW:
                // TA-TODO: Check for a button press here to go back to the start screen
                if (KEY_DOWN(BUTTON_START, currentButtons)) {
                    state = START;
                }
                break;
        }
        

        // Store the current state of the buttons
        previousButtons = currentButtons;
    }

    return 0;
}
